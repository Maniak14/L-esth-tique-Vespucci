<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upload Photos - L'Esthétique Vespucci</title>
  <link rel="icon" type="image/png" href="img/V.png">
  <link rel="stylesheet" href="assets/styles-logo.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="firebase-db.js"></script>
  <style>
    .upload-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      background: var(--bg-dark);
      min-height: 100vh;
    }
    
    .upload-header {
      text-align: center;
      margin-bottom: 3rem;
      padding: 2rem;
      background: var(--surface);
      border-radius: 20px;
      border: 1px solid var(--border);
    }
    
    .upload-header h1 {
      color: var(--text-primary);
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    
    .upload-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    .upload-section h2 {
      color: var(--text-primary);
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 0.5rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .form-group input[type="text"],
    .form-group input[type="file"] {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--bg-dark);
      color: var(--text-primary);
      font-size: 1rem;
    }
    
    .form-group input[type="file"] {
      cursor: pointer;
    }
    
    .form-group input[type="file"]::-webkit-file-upload-button {
      padding: 0.5rem 1rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 1rem;
    }
    
    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 1rem;
    }
    
    .btn:hover {
      background: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(32, 178, 170, 0.3);
    }
    
    .btn:disabled {
      background: var(--border);
      cursor: not-allowed;
      transform: none;
    }
    
    .progress-container {
      margin-top: 2rem;
      display: none;
    }
    
    .progress-container.active {
      display: block;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: var(--bg-dark);
      border-radius: 15px;
      overflow: hidden;
      border: 1px solid var(--border);
      margin-bottom: 1rem;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      width: 0%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .progress-info {
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 1rem;
    }
    
    .results {
      margin-top: 2rem;
      padding: 1.5rem;
      background: var(--bg-dark);
      border-radius: 10px;
      border: 1px solid var(--border);
      max-height: 400px;
      overflow-y: auto;
    }
    
    .result-item {
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      background: var(--surface);
      border-radius: 8px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .result-item.success {
      border-left: 4px solid #4caf50;
    }
    
    .result-item.error {
      border-left: 4px solid #f44336;
    }
    
    .result-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 5px;
      margin-right: 1rem;
    }
    
    .result-info {
      flex: 1;
    }
    
    .result-info .filename {
      color: var(--text-primary);
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    
    .result-info .url {
      color: var(--text-secondary);
      font-size: 0.85rem;
      word-break: break-all;
    }
    
    .info-box {
      background: rgba(32, 178, 170, 0.1);
      border: 1px solid var(--primary);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }
    
    .info-box strong {
      color: var(--primary);
    }
    
    .category-selector {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .category-btn {
      flex: 1;
      padding: 1rem;
      background: var(--bg-dark);
      border: 2px solid var(--border);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .category-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .category-btn:hover {
      border-color: var(--primary);
    }
  </style>
</head>
<body>
  <div class="upload-container">
    <div class="upload-header">
      <h1>Upload Photos en Masse</h1>
      <p style="color: var(--text-secondary);">Téléchargez vos photos sur imgbb et ajoutez-les automatiquement à la base de données</p>
    </div>

    <div class="upload-section">
      <h2>Configuration</h2>
      
      <div class="info-box">
        <strong>ℹ️ Clés API disponibles :</strong> Sélectionnez une clé API dans la liste déroulante ci-dessous, ou choisissez "Autre" pour saisir votre propre clé.
      </div>
      
      <div class="form-group">
        <label for="imgbbKey">Clé API imgbb :</label>
        <select id="imgbbKeySelect" onchange="selectApiKey(this.value)" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 10px; background: var(--bg-dark); color: var(--text-primary); font-size: 1rem; margin-bottom: 0.5rem;">
          <option value="">-- Sélectionner une clé API --</option>
          <option value="672588dfd08006a67d02c27a6d68483d">Clé API 1</option>
          <option value="305f63e58e1b10ba5245385343a3b8e9">Clé API 2</option>
          <option value="866b757bee23ff4ffb2a9f2552557aac">Clé API 3</option>
          <option value="custom">Autre (saisir manuellement)</option>
        </select>
        <input type="text" id="imgbbKey" placeholder="Ou saisir votre clé API imgbb manuellement" style="display: none;" />
      </div>
      
      <div class="category-selector">
        <button class="category-btn active" data-category="femmes" onclick="selectCategory('femmes')">
          Femmes
        </button>
        <button class="category-btn" data-category="hommes" onclick="selectCategory('hommes')">
          Hommes
        </button>
      </div>
      
      <div class="form-group">
        <label for="photoFiles">Sélectionner les photos (multiple) :</label>
        <input type="file" id="photoFiles" multiple accept="image/*" />
      </div>
      
      <button class="btn" id="uploadBtn" onclick="startUpload()">
        Uploader et Ajouter à la DB
      </button>
      
      <div class="progress-container" id="progressContainer">
        <div class="progress-info" id="progressInfo">Préparation...</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill">0%</div>
        </div>
      </div>
      
      <div class="results" id="results" style="display: none;"></div>
    </div>
  </div>

  <script>
    let selectedCategory = 'femmes';
    let firebaseInitialized = false;

    // Initialize Firebase
    document.addEventListener('DOMContentLoaded', async () => {
      if (initFirebaseDB && typeof initFirebaseDB === 'function') {
        firebaseInitialized = initFirebaseDB();
        if (firebaseInitialized) {
          await loadAllDataFromFirebase();
          console.log('Firebase initialisé');
        }
      }
    });

    function selectCategory(category) {
      selectedCategory = category;
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-category="${category}"]`).classList.add('active');
    }

    function selectApiKey(value) {
      const inputField = document.getElementById('imgbbKey');
      if (value === 'custom') {
        inputField.style.display = 'block';
        inputField.value = '';
        inputField.focus();
      } else if (value) {
        inputField.style.display = 'block';
        inputField.value = value;
      } else {
        inputField.style.display = 'none';
        inputField.value = '';
      }
    }

    async function startUpload() {
      // Récupérer la clé depuis le select ou l'input
      const selectKey = document.getElementById('imgbbKeySelect').value;
      const inputKey = document.getElementById('imgbbKey').value.trim();
      const imgbbKey = (selectKey && selectKey !== 'custom') ? selectKey : inputKey;
      const files = document.getElementById('photoFiles').files;
      
      if (!imgbbKey) {
        alert('Veuillez sélectionner ou entrer votre clé API imgbb');
        return;
      }
      
      if (files.length === 0) {
        alert('Veuillez sélectionner au moins une photo');
        return;
      }
      
      // Désactiver le bouton
      const uploadBtn = document.getElementById('uploadBtn');
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Upload en cours...';
      
      // Afficher la barre de progression
      const progressContainer = document.getElementById('progressContainer');
      progressContainer.classList.add('active');
      
      const resultsDiv = document.getElementById('results');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '';
      
      // Charger les images existantes pour déterminer le prochain numéro
      // Utiliser la même logique que dans admin.html (addNewFemmesImage/addNewHommesImage)
      const existingImages = await getExistingImages();
      
      // Trouver le prochain numéro disponible (même logique que admin.html)
      let nextNumber = 1;
      if (existingImages.length > 0) {
        const prefix = selectedCategory === 'femmes' ? 'femme_' : 'homme_';
        const numbers = existingImages
          .map(img => {
            const match = img.id.match(new RegExp(`${prefix}(\\d+)`));
            return match ? parseInt(match[1]) : 0;
          })
          .filter(n => n > 0)
          .sort((a, b) => b - a);
        nextNumber = numbers.length > 0 ? numbers[0] + 1 : existingImages.length + 1;
      }
      
      const totalFiles = files.length;
      let uploadedCount = 0;
      const results = [];
      
      // Upload chaque fichier
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const currentNumber = nextNumber + i;
        
        try {
          // Upload sur imgbb
          const imageUrl = await uploadToImgbb(file, imgbbKey);
          
          if (imageUrl) {
            // Créer l'objet image avec le bon numéro (même format que admin.html)
            const prefix = selectedCategory === 'femmes' ? 'femme' : 'homme';
            const newId = `${prefix}_${currentNumber}`;
            const imageData = {
              id: newId,
              url: imageUrl
            };
            
            // Ajouter à la liste existante (comme dans addNewFemmesImage/addNewHommesImage)
            existingImages.push(imageData);
            
            results.push({
              success: true,
              filename: file.name,
              url: imageUrl,
              number: currentNumber,
              id: newId
            });
            
            uploadedCount++;
          } else {
            results.push({
              success: false,
              filename: file.name,
              error: 'Échec de l\'upload'
            });
          }
        } catch (error) {
          console.error('Erreur upload:', error);
          results.push({
            success: false,
            filename: file.name,
            error: error.message || 'Erreur inconnue'
          });
        }
        
        // Mettre à jour la progression
        const progress = Math.round(((i + 1) / totalFiles) * 100);
        updateProgress(progress, `Upload ${i + 1}/${totalFiles} : ${file.name}`);
        
        // Afficher le résultat
        displayResult(results[results.length - 1]);
      }
      
      // Sauvegarder toutes les images dans Firebase et localStorage
      // Utiliser la même méthode que dans admin.html (addNewFemmesImage/addNewHommesImage)
      if (uploadedCount > 0) {
        try {
          if (selectedCategory === 'femmes') {
            // Sauvegarder dans localStorage (comme dans admin.html)
            localStorage.setItem('femmes_images', JSON.stringify(existingImages));
            // Sauvegarder dans Firebase (comme dans admin.html)
            if (firebaseInitialized && typeof saveFemmesImagesToFirebase === 'function') {
              saveFemmesImagesToFirebase(existingImages);
            }
          } else {
            // Sauvegarder dans localStorage (comme dans admin.html)
            localStorage.setItem('hommes_images', JSON.stringify(existingImages));
            // Sauvegarder dans Firebase (comme dans admin.html)
            if (firebaseInitialized && typeof saveHommesImagesToFirebase === 'function') {
              saveHommesImagesToFirebase(existingImages);
            }
          }
          
          updateProgress(100, `✅ ${uploadedCount} photo(s) ajoutée(s) avec succès ! Les images sont maintenant disponibles dans le catalogue.`);
          
          // Afficher un message de confirmation
          setTimeout(() => {
            const confirmMessage = confirm(`${uploadedCount} photo(s) ajoutée(s) avec succès !\n\nVoulez-vous aller à la page admin pour voir les résultats ?`);
            if (confirmMessage) {
              window.location.href = 'admin.html';
            }
          }, 500);
        } catch (error) {
          console.error('Erreur sauvegarde Firebase:', error);
          alert('Erreur lors de la sauvegarde dans Firebase. Les images ont été ajoutées à localStorage mais pas à Firebase.');
        }
      }
      
      // Réactiver le bouton
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Uploader et Ajouter à la DB';
    }

    async function getExistingImages() {
      // Utiliser la même méthode que dans admin.html pour charger les images
      const key = selectedCategory === 'femmes' ? 'femmes_images' : 'hommes_images';
      let images = JSON.parse(localStorage.getItem(key) || '[]');
      
      // Si pas d'images dans localStorage, charger depuis Firebase
      // (même logique que dans admin.html qui charge depuis Firebase au démarrage)
      if (images.length === 0 && firebaseInitialized) {
        if (selectedCategory === 'femmes' && typeof loadFemmesImagesFromFirebase === 'function') {
          await new Promise((resolve) => {
            loadFemmesImagesFromFirebase((data) => {
              images = data || [];
              // Mettre à jour localStorage pour cohérence
              if (images.length > 0) {
                localStorage.setItem('femmes_images', JSON.stringify(images));
              }
              resolve();
            });
          });
        } else if (selectedCategory === 'hommes' && typeof loadHommesImagesFromFirebase === 'function') {
          await new Promise((resolve) => {
            loadHommesImagesFromFirebase((data) => {
              images = data || [];
              // Mettre à jour localStorage pour cohérence
              if (images.length > 0) {
                localStorage.setItem('hommes_images', JSON.stringify(images));
              }
              resolve();
            });
          });
        }
      }
      
      return images;
    }

    async function uploadToImgbb(file, apiKey) {
      return new Promise((resolve, reject) => {
        // Convertir l'image en base64
        const reader = new FileReader();
        reader.onload = async function(e) {
          const base64 = e.target.result;
          // Enlever le préfixe data:image/...;base64,
          const base64Data = base64.split(',')[1];
          
          try {
            // L'API imgbb attend les données en FormData avec 'key' et 'image' (base64 sans préfixe)
            const formData = new FormData();
            formData.append('key', apiKey);
            formData.append('image', base64Data);
            
            const response = await fetch('https://api.imgbb.com/1/upload', {
              method: 'POST',
              body: formData
            });
            
            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }
            
            const data = await response.json();
            
            if (data.success && data.data && data.data.url) {
              resolve(data.data.url);
            } else {
              const errorMsg = data.error?.message || data.error?.message || JSON.stringify(data);
              reject(new Error('Erreur upload imgbb: ' + errorMsg));
            }
          } catch (error) {
            reject(error);
          }
        };
        
        reader.onerror = () => reject(new Error('Erreur lecture fichier'));
        reader.readAsDataURL(file);
      });
    }

    function updateProgress(percent, info) {
      const progressFill = document.getElementById('progressFill');
      const progressInfo = document.getElementById('progressInfo');
      
      progressFill.style.width = percent + '%';
      progressFill.textContent = percent + '%';
      progressInfo.textContent = info;
    }

    function displayResult(result) {
      const resultsDiv = document.getElementById('results');
      const resultItem = document.createElement('div');
      resultItem.className = `result-item ${result.success ? 'success' : 'error'}`;
      
      if (result.success) {
        resultItem.innerHTML = `
          <img src="${result.url}" alt="${result.filename}" />
          <div class="result-info">
            <div class="filename">✅ ${result.filename} - ${result.id || `Photo #${result.number}`}</div>
            <div class="url">${result.url}</div>
            <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--primary);">✓ Ajouté à la base de données</div>
          </div>
        `;
      } else {
        resultItem.innerHTML = `
          <div class="result-info">
            <div class="filename">❌ ${result.filename}</div>
            <div class="url">Erreur: ${result.error}</div>
          </div>
        `;
      }
      
      resultsDiv.appendChild(resultItem);
      resultsDiv.scrollTop = resultsDiv.scrollHeight;
    }
  </script>
</body>
</html>

